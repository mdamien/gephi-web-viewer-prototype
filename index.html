<script src="static/jquery.js" ></script>
<script src="static/sigma.js" ></script>
<script src="static/plugins.js" ></script>
<div>
  <style>
    #graph-container {
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      position: absolute;
      background: #eee;
    }
    #infopane {
      top: 0;
      bottom: 0;
      right: 0;
      position: absolute;
      width: 230px;
      display: none;
      padding: 10px;
      background-color: rgb(249, 247, 237);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #infopane > div {
      margin: 10px;
      overflow-x: auto;
    }
  </style>
  <div id="graph-container"></div>
  <div id="infopane">
    <h2 id="ip-node-name"></h2>
    <pre id="ip-infos"></pre>
  </div>

</div>
<script>

function parseJSON(data) {
  var g = {
    nodes: [],
    edges: []
  };

  for (i=0; i<data.nodes.length; i++){
    var node = data.nodes[i];
    // s.addNode(id,data.nodes[i]);

    g.nodes.push({
      id: node.id,
      label: node.label,
      x: node.x,
      y: node.y,
      size: node.size + 3,
      color: node.color,
    });
  }

  for(j=0; j<data.edges.length; j++){
    var edge = data.edges[j];

    g.edges.push({
      id: edge.id,
      source: edge.source,
      target: edge.target,
      // size: edge.size,
      color: edge.color,
      type: 'curve',
    });
  }

  return g;
}

function nodeByID(s, id) {
  return s.graph.nodes().filter(node => node['id'] === id).pop();
}

$.getJSON('data.json', function (data) {
  var g = parseJSON(data);

  var s = new sigma({
    graph: g, 
    renderer: {
      container: 'graph-container',
      type: sigma.renderers.canvas,
    },
    settings: {
      hideEdgesOnMove: true,
      maxNodeSize: 10,
      minNodeSize: 0.00001,
      autoRescale: false,
    },
  });

  s.camera.goTo({
    x: 0,
    y: 0,
    angle: 0,
    ratio: 3
  });

  var filter = new sigma.plugins.filter(s);

  s.bind('clickNode', function(e) {
    filter.undo()
    filter.neighborsOf(e.data.node.id).apply();

    $('#infopane').show()
    $('#ip-node-name').text(e.data.node.label)

    var incoming = '';
    var outcoming = '';

    g.edges.forEach(function(edge) {
      if (edge.source == e.data.node.id) {
        outcoming += nodeByID(s, edge.target).label + '\n';
      }
      else if (edge.target == e.data.node.id) {
        incoming += nodeByID(s, edge.source).label + '\n';
      }
    })

    if (incoming) {
      incoming = 'Incoming: \n' + incoming + '\n';
    }
    if (outcoming) {
      outcoming = 'Outcoming: \n' + outcoming + '\n';
    }

    $('#ip-infos').text(incoming+outcoming)
    // s.refresh()
  });

  s.bind('clickStage', function(e) {
    filter.undo().apply();
  });
});
</script>