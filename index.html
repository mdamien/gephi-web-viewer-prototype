<!DOCTYPE html>
<html>
<head>
  <title>gephi-web-viewer</title>
  <script src="static/jquery.js" ></script>
  <script src="static/sigma.js" ></script>
  <script src="static/plugins.js" ></script>
  <style>
    #graph-container {
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      position: absolute;
      background: #eee;
    }
    #rightpanel {
      top: 0;
      bottom: 0;
      right: 0;
      position: absolute;
      width: 300px;
      display: none;
      padding: 10px;
      background-color: rgb(249, 247, 237);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      overflow: auto;
    }
    #leftpanel {
      margin-top: 50px;
      margin-left: 25px;
      background: #fff;
      background-color: rgb(255, 255, 255);
      background-color: rgba(255,255,255,0.8);
      border: 1px solid #ccc;
      position: fixed;
      top: 0;
      padding: 10px;
      width: 300px;
      overflow: auto;
      max-height: 50%;
    }
  </style>
</head>
</body>
<div>
  <div id="graph-container"></div>
  <div id="leftpanel"></div>
  <div id="rightpanel"></div>
</div>

<script>

var s; // sigma instance
var s_filter; // sigma filter plugin

function parseJSON(data) {
  var g = {
    nodes: [],
    edges: []
  };

  for (i=0; i<data.nodes.length; i++){
    var node = data.nodes[i];
    // s.addNode(id,data.nodes[i]);

    g.nodes.push({
      id: node.id,
      label: node.label,
      x: node.x,
      y: node.y,
      size: node.size + 3,
      color: node.color,
      attributes: node.attributes,
    });
  }

  for(j=0; j<data.edges.length; j++){
    var edge = data.edges[j];

    g.edges.push({
      id: edge.id,
      source: edge.source,
      target: edge.target,
      size: edge.size,
      color: edge.color,
      type: 'curve',
    });
  }

  return g;
}

function nodeByID(id) {
  return s.graph.nodes().filter(node => node['id'] === id).pop();
}

function getNodeInfos(node) {
  html = "<h2>" + node.label + "</h2>";
  html += getNodeAttributesInfos(node)
  html += '<hr>'
  html += getNodeLinkInfos(node)
  return html
}

function getNodeAttributesInfos(node) {
  var attributes = node.attributes;
  var attributes_text = '';

  for (attribute in attributes) {
    var value = attributes[attribute];
    attributes_text += "<strong>" + attribute + ': ' + "</strong>" + value + '<br><br>'
  }

  if (attributes_text) {
    attributes_text += '\n\n'
  }

  return attributes_text;
}

function getNodeLinkInfos(node) {
    var incoming = [];
    var outcoming = [];

    s.graph.edges().forEach(function(edge) {
      if (edge.source == node.id) {
        outcoming.push(nodeByID(edge.target).id);
      }
      else if (edge.target == node.id) {
        incoming.push(nodeByID(edge.source).id);
      }
    })

    var incoming_filtered = [];
    var outcoming_filtered = [];
    var mutual = [];
    incoming.forEach(function(node) {
      if (outcoming.indexOf(node) === -1) {
        incoming_filtered.push(node)
      } else {
        mutual.push(node)
      }
    });
    outcoming.forEach(function(node) {
      if (incoming.indexOf(node) === -1) {
        outcoming_filtered.push(node)
      }
    });

    incoming = incoming_filtered.map(node => nodeByID(node))
    outcoming = outcoming_filtered.map(node => nodeByID(node))
    mutual = mutual.map(node => nodeByID(node))

    var mutual_html = ''
    if (mutual.length) {
      mutual_html = '<strong>Mutal</strong><br>'
      mutual_html += '<ul>'
      mutual.forEach(node => {
        mutual_html += '<li>'
        mutual_html += '<a href="#' + node.id + '">'
        mutual_html += node.label
        mutual_html += '</a>'
        mutual_html += '</li>'
      })
      mutual_html += '</ul>'
    }
    var incoming_html = ''
    if (incoming.length) {
      incoming_html = '<strong>Incoming</strong><br>'
      incoming_html += '<ul>'
      incoming.forEach(node => {
        incoming_html += '<li>'
        incoming_html += '<a href="#' + node.id + '">'
        incoming_html += node.label
        incoming_html += '</a>'
        incoming_html += '</li>'
      })
      incoming_html += '</ul>'
    }
    var outcoming_html = ''
    if (outcoming.length) {
      outcoming_html = '<strong>Outcoming</strong><br>'
      outcoming_html += '<ul>'
      outcoming.forEach(node => {
        outcoming_html += '<li>'
        outcoming_html += '<a href="#' + node.id + '">'
        outcoming_html += node.label
        outcoming_html += '</a>'
        outcoming_html += '</li>'
      })
      outcoming_html += '</ul>'
    }
    html = "<p><strong>" + "Connections" + "</strong></p>"
    html += mutual_html
    html += incoming_html
    html += outcoming_html
    return html
}

function renderLeftPanel(config_data) {
  html = "<h3>" + config_data.text.title + "</h3>"
  html += "<p><input type='text' placeholder='search'/></p>"
  html += "<p id='search-results'></p>"
  $('#leftpanel').html(html)
  $('#leftpanel input').on('input', function() {
    var q = $(this).val().toLowerCase();
    var results = [];
    if (q) {
      results = s.graph.nodes().filter(node => node.label.toLowerCase().indexOf(q) !== -1);
    }
    html_results = ''
    if (results.length) {
      html_results = '<ul>'
      results.forEach(node => {
        html_results += '<li>'
        html_results += '<a href="#' + node.id + '">'
        html_results += node.label
        html_results += '</a>'
        html_results += '</li>'
      })
      html_results += '</ul>'
    }
    $('#search-results').html(html_results);
  })
}

function locationHashChanged() {
  if (location.hash) {
    var node_id = location.hash.substring(1)
    selectNode(node_id);
  }
}

function selectNode(node_id) {
    s_filter.undo()
    s_filter.neighborsOf(node_id).apply();
    $('#rightpanel').html(getNodeInfos(nodeByID(node_id)))
    $('#rightpanel').show()
}

$.getJSON('data.json', function (data) {
  $.getJSON('config.json', function (config_data) {

    var g = parseJSON(data);

    s = new sigma({
      graph: g, 
      renderer: {
        container: 'graph-container',
        type: sigma.renderers.canvas,
      },
      settings: {
        hideEdgesOnMove: true,
        autoRescale: false,
        zoomMax: 10,
      },
    });

    renderLeftPanel(config_data);

    s.camera.goTo({
      x: 0,
      y: 0,
      angle: 0,
      ratio: 3
    });

    s_filter = new sigma.plugins.filter(s);

    s.bind('clickNode', function(e) {
      selectNode(e.data.node.id)
    });

    s.bind('clickStage', function(e) {
      s_filter.undo().apply();
      $('#rightpanel').hide();
      window.location.hash = '';
    });

    window.onhashchange = locationHashChanged;
  });
});
</script>
</body>